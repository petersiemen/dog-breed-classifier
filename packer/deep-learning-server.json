{
  "builders": [
    {
      "type": "amazon-ebs",
      "source_ami": "{{user `deep_learning_aws_ami`}}",
      "region": "eu-central-1",
      "instance_type": "p2.xlarge",
      "ena_support": true,
      "ssh_username": "ec2-user",
      "ami_name": "ACME Development Deep Learning AMI {{isotime \"2006-01-02_15_04_05\"}}",
      "ami_users": "{{user `share_with_accounts` }}",
      "run_tags": {
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sudo yum -y -q update",
        "sudo yum -y -q upgrade",
        "ssh-keyscan github.com >> ~/.ssh/known_hosts",
        "git clone git@github.com:petersiemen/deep-learning-aws.git",
        "pip3 install --user pipenv",
        "pip install --upgrade pip",

        "sudo yum install -y -q cmake3",
        "ln -s /usr/bin/cmake3 /usr/local/bin/cmake",
        "cd /home/ec2-user/deep-learning-aws/dog-breed-classifier && /home/ec2-user/.local/bin/pipenv install",

        "curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.rpm.sh | sudo bash",
        "sudo yum install -y -q git-lfs",
        "rm -r /home/ec2-user/anaconda*",
        "rm -r /home/ec2-user/examples",
        "mkdir -p /home/ec2-user/datasets",
        "cd /home/ec2-user/datasets && curl https://s3-us-west-1.amazonaws.com/udacity-aind/dog-project/dogImages.zip -o dogImages.zip",
        "cd /home/ec2-user/datasets && unzip dogImages.zip",
        "cd /home/ec2-user/datasets && curl http://vis-www.cs.umass.edu/lfw/lfw.tgz -o lfw.tgz",
        "cd /home/ec2-user/datasets && tar -xvzf lfw.tgz"
      ]
    }
  ]
}
